require 'rest_client'
module NationalRailApiHelper

  DEBUG = true
  URL = 'https://lite.realtime.nationalrail.co.uk/OpenLDBWS/ldb6.asmx'
  ACCESS_TOKEN = ENV['TRAINS_ACCESS_TOKEN']
  SOAP_HEADERS = '<?xml version="1.0"?><SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ns1="http://thalesgroup.com/RTTI/2014-02-20/ldb/" xmlns:ns2="http://thalesgroup.com/RTTI/2010-11-01/ldb/commontypes"><SOAP-ENV:Header><ns2:AccessToken><ns2:TokenValue>' + ACCESS_TOKEN + '</ns2:TokenValue></ns2:AccessToken></SOAP-ENV:Header>'


  def self.get_departure_board crs    
    type = "DepartureBoard"
    return NationalRailApiHelper.get_board type, crs
  end


  def self.get_arrival_board crs    
    type = "ArrivalBoard"
    return NationalRailApiHelper.get_board type, crs
  end
  

  def self.get_service service_id
    soap_body = '<SOAP-ENV:Body><ns1:GetServiceDetailsRequest><ns1:serviceID>' + service_id + '</ns1:serviceID></ns1:GetServiceDetailsRequest></SOAP-ENV:Body></SOAP-ENV:Envelope>'
    begin
      if DEBUG
        service_id = "bdJjEsW1qGlc+zPnxyO5lA=="
        xml = '<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"><soap:Body><GetServiceDetailsResponse xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/"><GetServiceDetailsResult><generatedAt xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">2015-02-24T21:15:02.8287755+00:00</generatedAt><serviceType xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">train</serviceType><locationName xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">Cardiff Central</locationName><crs xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">CDF</crs><operator xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">Arriva Trains Wales</operator><operatorCode xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">AW</operatorCode><sta xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">20:59</sta><ata xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">21:01</ata><std xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">21:10</std><atd xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">On time</atd><previousCallingPoints xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types"><callingPointList serviceType="train" serviceChangeRequired="false" assocIsCancelled="false"><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Caerphilly</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">CPH</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">20:40</st><at xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</at></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Lisvane &amp; Thornhill</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">LVT</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">20:44</st><at xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</at></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Llanishen</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">LLS</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">20:46</st><at xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">20:48</at></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Heath High Level</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">HHL</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">20:49</st><at xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</at></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Cardiff Queen Street</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">CDQ</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">20:56</st><at xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">20:58</at></callingPoint></callingPointList></previousCallingPoints><subsequentCallingPoints xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types"><callingPointList serviceType="train" serviceChangeRequired="false" assocIsCancelled="false"><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Grangetown</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">GTN</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:14</st><at xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</at></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Cogan</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">CGN</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:18</st><et xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</et></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Eastbrook</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">EBK</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:20</st><et xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</et></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Dinas Powys</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">DNS</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:22</st><et xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</et></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Cadoxton</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">CAD</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:26</st><et xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</et></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Barry Docks</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">BYD</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:29</st><et xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</et></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Barry</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">BRY</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:33</st><et xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</et></callingPoint><callingPoint><locationName xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">Barry Island</locationName><crs xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">BYI</crs><st xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">21:40</st><et xmlns="http://thalesgroup.com/RTTI/2012-01-13/ldb/types">On time</et></callingPoint></callingPointList></subsequentCallingPoints></GetServiceDetailsResult></GetServiceDetailsResponse></soap:Body></soap:Envelope>'
        xml = Nokogiri::XML(xml)
      else
        response = RestClient.post URL, SOAP_HEADERS + soap_body, content_type: 'text/xml'
        xml = Nokogiri::XML(response.body)
      end
    rescue => e
      puts e.inspect
      return
    end
    xml.remove_namespaces!
    service = Service.new service_id
    service.parse(xml)
    return service
  end


  def self.get_board type, crs
    soap_body = '<SOAP-ENV:Body><ns1:Get' + type + 'Request><ns1:crs>' + crs + '</ns1:crs></ns1:Get' + type + 'Request></SOAP-ENV:Body></SOAP-ENV:Envelope>'
    begin
      if DEBUG
        xml = '<?xml version="1.0" encoding="utf-8"?><soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema"><soap:Body><GetDepartureBoardResponse xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/"><GetStationBoardResult><generatedAt xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">2015-02-24T20:49:23.9684714+00:00</generatedAt><locationName xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">Cardiff Central</locationName><crs xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">CDF</crs><platformAvailable xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types">true</platformAvailable><trainServices xmlns="http://thalesgroup.com/RTTI/2014-02-20/ldb/types"><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Coryton</locationName><crs>COY</crs><via /><futureChangeTo /></location></destination><std>20:51</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>l/RVKDW35beco0VviRQIZw==</serviceID></service><service><origin><location><locationName>London Paddington</locationName><crs>PAD</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Swansea</locationName><crs>SWA</crs><via /><futureChangeTo /></location></destination><std>20:54</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>BfCt0BCYrR9fMKKitaIfbw==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Westbury</locationName><crs>WSB</crs><via /><futureChangeTo /></location></destination><std>21:00</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>7XXg/xWf4s9RT1y8GGeRJQ==</serviceID></service><service><origin><location><locationName>Penarth</locationName><crs>PEN</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Ystrad Mynach</locationName><crs>YSM</crs><via /><futureChangeTo /></location></destination><std>21:01</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>Z6u3YxSS1jD2CsGpTAMbMQ==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Milford Haven</locationName><crs>MFH</crs><via /><futureChangeTo /></location></destination><std>21:04</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>f9qq9NUIrprr9Z7NwPGeWA==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Birmingham New Street</locationName><crs>BHM</crs><via /><futureChangeTo /></location></destination><std>21:05</std><etd>On time</etd><operator>CrossCountry</operator><operatorCode>XC</operatorCode><serviceID>DbBRdtYDwVR/uC9/4ylgLw==</serviceID></service><service><origin><location><locationName>Aberdare</locationName><crs>ABA</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Penarth</locationName><crs>PEN</crs><via /><futureChangeTo /></location></destination><std>21:06</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>WlD94W2MTruokbPFGSQR7w==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Treherbert</locationName><crs>TRB</crs><via /><futureChangeTo /></location></destination><std>21:06</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>5OYaoAh/mo4v0an1xx/ouQ==</serviceID></service><service><origin><location><locationName>Caerphilly</locationName><crs>CPH</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Barry Island</locationName><crs>BYI</crs><via /><futureChangeTo /></location></destination><std>21:10</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>bdJjEsW1qGlc+zPnxyO5lA==</serviceID></service><service><origin><location><locationName>Cheltenham Spa</locationName><crs>CNM</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Maesteg</locationName><crs>MST</crs><via /><futureChangeTo /></location></destination><std>21:10</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>1iGyJigfAi64H1MDescL9w==</serviceID></service><service><origin><location><locationName>Maesteg</locationName><crs>MST</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Cheltenham Spa</locationName><crs>CNM</crs><via /><futureChangeTo /></location></destination><std>21:12</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>B2SlP3ik7uz+T9261axkgw==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Chester</locationName><crs>CTR</crs><via>via Shrewsbury</via><futureChangeTo /></location></destination><std>21:17</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>Xk3U6fJWUVbrU9V3Q03Qqg==</serviceID></service><service><origin><location><locationName>London Paddington</locationName><crs>PAD</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Swansea</locationName><crs>SWA</crs><via /><futureChangeTo /></location></destination><std>21:24</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>6PLqM5pT9+XpRU2pDp79VA==</serviceID></service><service><origin><location><locationName>Swansea</locationName><crs>SWA</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Swindon</locationName><crs>SWI</crs><via /><futureChangeTo /></location></destination><std>21:25</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>QbEPzXXe1xCFb73AU2rGFw==</serviceID></service><service><origin><location><locationName>Barry Island</locationName><crs>BYI</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Merthyr Tydfil</locationName><crs>MER</crs><via /><futureChangeTo /></location></destination><std>21:27</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>NfTEAKDXTGWb04L9TSQkfw==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Bristol Temple Meads</locationName><crs>BRI</crs><via /><futureChangeTo /></location></destination><std>21:30</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>zaSV3k8t+ahgVBmNl/siyg==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Penarth</locationName><crs>PEN</crs><via /><futureChangeTo /></location></destination><std>21:31</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>ZGyhQExkLLKn2GL+k5EbSA==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Rhymney</locationName><crs>RHY</crs><via /><futureChangeTo /></location></destination><std>21:31</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>n5txdOydgdKKf3zlEo/3gA==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Ebbw Vale Parkway</locationName><crs>EBV</crs><via /><futureChangeTo /></location></destination><std>21:35</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>Nj35NjdR9MCbZNhKXADj4g==</serviceID></service><service><origin><location><locationName>Coryton</locationName><crs>COY</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Radyr</locationName><crs>RDR</crs><via>via Ninian Park</via><futureChangeTo /></location></destination><std>21:36</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>i9BLmjP3Z8GKCxtR0JOPUg==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Bristol Temple Meads</locationName><crs>BRI</crs><via /><futureChangeTo /></location></destination><std>21:40</std><etd>On time</etd><operator>CrossCountry</operator><operatorCode>XC</operatorCode><serviceID>2j3Prc2lJoYlPR09hNWRPw==</serviceID></service><service><origin><location><locationName>Bridgend</locationName><crs>BGN</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Aberdare</locationName><crs>ABA</crs><via /><futureChangeTo /></location></destination><std>21:41</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>Flajrpqd+Aw63E/xag2NZA==</serviceID></service><service><origin><location><locationName>Merthyr Tydfil</locationName><crs>MER</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Bridgend</locationName><crs>BGN</crs><via>via Rhoose Cardiff Int Airport</via><futureChangeTo /></location></destination><std>21:41</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>NCwPhZw4pFyU6HvmcS8PKQ==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Birmingham New Street</locationName><crs>BHM</crs><via /><futureChangeTo /></location></destination><std>21:50</std><etd>On time</etd><operator>CrossCountry</operator><operatorCode>XC</operatorCode><serviceID>Q7k6M1MB/IffPcJHWDBuHA==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Crewe</locationName><crs>CRE</crs><via>via Shrewsbury</via><futureChangeTo /></location></destination><std>21:55</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>lSULldpayD5EhEORnBVE9A==</serviceID></service><service><origin><location><locationName>Aberdare</locationName><crs>ABA</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Penarth</locationName><crs>PEN</crs><via /><futureChangeTo /></location></destination><std>21:56</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>KXHUtDq2XO1AOwPDraKeOA==</serviceID></service><service><origin><location><locationName>Penarth</locationName><crs>PEN</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Caerphilly</locationName><crs>CPH</crs><via /><futureChangeTo /></location></destination><std>22:01</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>AFQRKo+qmDPtvMkD5aZn9Q==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Bristol Temple Meads</locationName><crs>BRI</crs><via /><futureChangeTo /></location></destination><std>22:04</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>aFTrVGTxUe8KL0O5iLC+xw==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Treherbert</locationName><crs>TRB</crs><via /><futureChangeTo /></location></destination><std>22:06</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>rYrBbTPOY+DIdoW0O/IEcA==</serviceID></service><service><origin><location><locationName>Manchester Piccadilly</locationName><crs>MAN</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Carmarthen</locationName><crs>CMN</crs><via /><futureChangeTo /></location></destination><std>22:09</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>jXTaOSZ8ONbnk9zq0kISbA==</serviceID></service><service><origin><location><locationName>Ystrad Mynach</locationName><crs>YSM</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Barry Island</locationName><crs>BYI</crs><via /><futureChangeTo /></location></destination><std>22:10</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>KKM8b8tdH/VSbtYvCjiqVw==</serviceID></service><service><origin><location><locationName>Radyr</locationName><crs>RDR</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Coryton</locationName><crs>COY</crs><via /><futureChangeTo /></location></destination><std>22:21</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>0VZQGLojwxgJSZqE7eMXTA==</serviceID></service><service><origin><location><locationName>Barry Island</locationName><crs>BYI</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Pontypridd</locationName><crs>PPD</crs><via /><futureChangeTo /></location></destination><std>22:26</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>W0uMvAUUCsr3aPFrhxmHyQ==</serviceID></service><service><origin><location><locationName>London Paddington</locationName><crs>PAD</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Swansea</locationName><crs>SWA</crs><via /><futureChangeTo /></location></destination><std>22:26</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>AP7YQk/pDQMrLHh1c/6GuQ==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Maesteg</locationName><crs>MST</crs><via /><futureChangeTo /></location></destination><std>22:35</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>ecSYsBnuujuFsgDXY18nQw==</serviceID></service><service><origin><location><locationName>Penarth</locationName><crs>PEN</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Rhymney</locationName><crs>RHY</crs><via /><futureChangeTo /></location></destination><std>22:35</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>14DhPS+NRNZN7lOhqPgsZA==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Bristol Temple Meads</locationName><crs>BRI</crs><via /><futureChangeTo /></location></destination><std>22:36</std><etd>On time</etd><operator>First Great Western</operator><operatorCode>GW</operatorCode><serviceID>esdljRLbVqCD8+J8M0LldQ==</serviceID></service><service><origin><location><locationName>Rhymney</locationName><crs>RHY</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Penarth</locationName><crs>PEN</crs><via /><futureChangeTo /></location></destination><std>22:36</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>VSwGl3kbheNFbZQ5o/HoGQ==</serviceID></service><service><origin><location><locationName>Merthyr Tydfil</locationName><crs>MER</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Bridgend</locationName><crs>BGN</crs><via>via Rhoose Cardiff Int Airport</via><futureChangeTo /></location></destination><std>22:41</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>QdlmGr1uOgvfcrxUTaN7Xg==</serviceID></service><service><origin><location><locationName>Cardiff Central</locationName><crs>CDF</crs><via /><futureChangeTo /></location></origin><destination><location><locationName>Treherbert</locationName><crs>TRB</crs><via /><futureChangeTo /></location></destination><std>22:46</std><etd>On time</etd><operator>Arriva Trains Wales</operator><operatorCode>AW</operatorCode><serviceID>009A3HDe+BIa07FF/Wka9A==</serviceID></service></trainServices></GetStationBoardResult></GetDepartureBoardResponse></soap:Body></soap:Envelope>'
        xml = Nokogiri::XML(xml)
      else
        response = RestClient.post URL, SOAP_HEADERS + soap_body, content_type: 'text/xml'
        xml = Nokogiri::XML(response.body)
      end
    rescue => e
      puts e.inspect
      return
    end
    xml.remove_namespaces!
    station_board = StationBoard.new
    station_board.parse(xml)
    return station_board
  end


end
